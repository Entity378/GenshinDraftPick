<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Game Lobby</title>
  <link rel="stylesheet" href="/game_styles.css" />
</head>

<body autocomplete="off">
  <div class="main-layout">
    <!-- Container chat -->
    <div id="chat-box-container">
      <div id="chat-box"></div>
      <input type="text" id="chat-input" placeholder="Send a message..." autocomplete="off" />
    </div>

    <!-- Container sinistro -->
    <div class="side-container left">
      <h2 id="blue-username" style="text-align: center">Blue</h2>
      <div class="bans-text">Bans</div>
      <div id="blue-team-bans" class="blue-team-bans">
        <div id="blue-ban-row" class="ban-row"></div>
      </div>
      <div id="blue-team-picks" class="blue-team-picks"></div>
    </div>

    <!-- Container principale -->
    <div class="container">
      <h2 style="text-align: center">Characters</h2>
      <input type="text" id="search-bar" placeholder="Search for a character..." autocomplete="off" />
      <div id="characters-box">
        <div id="characters-list"></div>
      </div>
      <button id="submit-btn" class="submit-btn" onclick="sumbitCharacter()">Seleziona</button>
      <div id="current-phase" class="current-phase"></div>
    </div>

    <!-- Container destro -->
    <div class="side-container right">
      <h2 id="red-username" style="text-align: center">Red</h2>
      <div class="bans-text">Bans</div>
      <div id="red-team-bans" class="red-team-bans">
        <div id="red-ban-row" class="ban-row"></div>
      </div>
      <div id="red-team-picks" class="red-team-picks"></div>
      <!-- Contenuto opzionale -->
      <!-- <div class="bansNumber" id="bansNumber"></div> -->
      <!-- <div class="teamsNumber" id="teamsNumber"></div> -->
      <!-- <ul id="participants"></ul> -->
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const roomId = window.location.pathname.split("/")[2];
    const username = new URLSearchParams(window.location.search).get("username");

    const chatContainer = document.getElementById("chat-box-container");
    const chatBox = document.getElementById("chat-box");
    const chatInput = document.getElementById("chat-input");
    const sendBtn = document.getElementById("send-btn");
    const participantsList = document.getElementById("participants");
    const bansNumberText = document.getElementById("bansNumber");
    const teamsNumberText = document.getElementById("teamsNumber");
    const blueSideBansContainer = document.getElementById("blue-ban-row");
    const redSideBansContainer = document.getElementById("red-ban-row");
    const blueSidePicksContainer = document.getElementById("blue-team-picks");
    const redSidePicksContainer = document.getElementById("red-team-picks");
    const currentPhaseText = document.getElementById("current-phase");
    const redUsernameText = document.getElementById("red-username");
    const blueUsernameText = document.getElementById("blue-username");

    var allPicksAndBans = [];

    var msgSent = false;
    var selectedCharacter = null;
    var bansNumber = null;
    var teamsNumber = null;
    var savedCharacters = [];

    // ----------------------
    // GESTIONE GAME
    // ----------------------

    // Viene startato il game
    socket.emit("join-game", roomId, username);

    // Ricevuto un messaggio della chat
    socket.on("chat-message", (message) => {
      const messageElement = document.createElement("div");
      messageElement.textContent = message;
      chatBox.appendChild(messageElement);

      if (!chatContainer.classList.contains("active") || msgSent == true) {
        chatBox.scrollBy(0, chatBox.scrollHeight);
        msgSent = false;
      }
    });

    socket.on("update-player-hover", (selectedCharacter, playerUsername, phaseType) => {
      const imgLink = getImageLinkByName(selectedCharacter);
      if (!imgLink) return;

      // Determina i container giusti in base al team
      let slotSelector = "";
      if (playerUsername == redUsernameText.innerText) {
        slotSelector = phaseType === "ban" ? ".red-ban-row-slot.slot-empty" : ".red-pick-slot.slot-empty";
      } else if (playerUsername == blueUsernameText.innerText) {
        slotSelector = phaseType === "ban" ? ".blue-ban-row-slot.slot-empty" : ".blue-pick-slot.slot-empty";
      }

      if (!slotSelector) return;

      const emptySlot = document.querySelector(slotSelector);
      if (emptySlot) {
        emptySlot.innerHTML = `<img src="${imgLink}" title="${selectedCharacter}" class="mini-character hover"/>`;
      }
    });

    socket.on("update-game-state", (blueSideBans, redSideBans, blueSidePicks, redSidePicks, currentPhase, currentUsername) => {
      if (Array.isArray(blueSideBans)) {
        blueSideBans.forEach((char, i) => {
          const slot = document.getElementById(`blue-ban-row-slot-${i}`);
          slot.className = "blue-ban-row-slot";
          slot.innerHTML = char ? `<img src="${getImageLinkByName(char)}" title="${char}" class="mini-character ban"/>` : "";
        });
      }
      if (Array.isArray(redSideBans)) {
        redSideBans.forEach((char, i) => {
          const slot = document.getElementById(`red-ban-row-slot-${i}`);
          slot.className = "red-ban-row-slot";
          slot.innerHTML = char ? `<img src="${getImageLinkByName(char)}" title="${char}" class="mini-character ban"/>` : "";
        });
      }
      if (Array.isArray(blueSidePicks)) {
        blueSidePicks.forEach((char, i) => {
          const slot = document.getElementById(`blue-pick-slot-${i}`);
          slot.className = "blue-pick-slot";
          slot.innerHTML = char ? `<img src="${getImageLinkByName(char)}" title="${char}" class="mini-character"/>` : "";
        });
      }
      if (Array.isArray(redSidePicks)) {
        redSidePicks.forEach((char, i) => {
          const slot = document.getElementById(`red-pick-slot-${i}`);
          slot.className = "red-pick-slot";
          slot.innerHTML = char ? `<img src="${getImageLinkByName(char)}" title="${char}" class="mini-character"/>` : "";
        });
      }
      allPicksAndBans = [...blueSideBans, ...redSideBans, ...blueSidePicks, ...redSidePicks];
      updateCharactersList(allPicksAndBans);
      currentPhaseText.innerHTML = generatePhaseText(currentPhase, currentUsername);
    });

    function updateCharactersList(characters, removeOnClick = true) {
      characters.forEach((char, i) => {
        const character = document.getElementById(char);
        if (!character) return;
        character.className = "disabled";
        if (removeOnClick)
          character.onclick = null;
      });
    }

    function generatePhaseText(phaseType, username) {
      var text = "";
      if (username == redUsernameText.innerText) {
        text += "Red team's";
      } else {
        text += "Blue team's";
      }
      if (phaseType === "ban") {
        text += " turn to ban.";
      } else if (phaseType === "pick") {
        text += " turn to pick.";
      } else if (phaseType === "end") {
        text = "Draft phase ended.";
      }
      return text;
    }

    // Espandi la chat e abilitala quando ci si clicca sopra
    chatContainer.addEventListener("click", (e) => {
      chatContainer.classList.add("active"); // espandi la chat

      if (e.target === chatInput) {
        // Se clicco sull'input: focus normale
        chatInput.focus();
      } else {
        // Se clicco altrove nel container: non focusare l'input
        chatInput.blur();
      }
    });

    // Risuci la chat se si clicca da qualche altra parte
    document.addEventListener("click", (e) => {
      if (!chatContainer.contains(e.target)) {
        chatContainer.classList.remove("active"); // riduci la chat
        chatInput.blur();
        chatBox.scrollBy(0, chatBox.scrollHeight);
      }
    });

    // Invio del messaggio nella chat
    chatInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        const message = chatInput.value.trim();
        if (message) {
          socket.emit("send-chat-message", roomId, message);
          chatInput.value = "";
        }
        e.preventDefault(); // previene invio del form se c'Ã¨
        msgSent = true;
      }
    });

    function createTeamSlots(container, slotsCount, type) {
      container.innerHTML = "";

      if (type.includes("pick")) {
        // Per i pick, creiamo righe di 4 slot ciascuna
        const rows = Math.ceil(slotsCount / 4);
        for (let r = 0; r < rows; r++) {
          const teamText = document.createElement("div");
          teamText.textContent = "Team " + (r + 1);
          if (container == redSidePicksContainer) {
            teamText.className = "red-pick-text";
          } else {
            teamText.className = "blue-pick-text";
          }
          const rowDiv = document.createElement("div");
          rowDiv.className = "pick-row";

          for (let i = 0; i < 4; i++) {
            const slotIndex = r * 4 + i;
            if (slotIndex >= slotsCount) break;

            const slot = document.createElement("div");
            slot.className = `${type}-slot slot-empty`;
            slot.id = `${type}-slot-${slotIndex}`;
            slot.innerHTML = `<img src="https://github.com/Entity378/GenshinDraftPick/blob/main/Resources/Images/Generic_Icons/Empty.png?raw=true" class="mini-character"/>`;
            rowDiv.appendChild(slot);
          }
          container.appendChild(teamText);
          container.appendChild(rowDiv);
        }
      } else {
        // Per i ban, creiamo una semplice riga orizzontale
        if (slotsCount == 0) {
          const noBansText = document.createElement("div");
          noBansText.textContent = "No bans";
          noBansText.className = "bans-text";
          container.appendChild(noBansText);
          return;
        }
        for (let i = 0; i < slotsCount; i++) {
          const slot = document.createElement("div");
          slot.className = `${type}-slot slot-empty`;
          slot.id = `${type}-slot-${i}`;
          slot.innerHTML = `<img src="https://github.com/Entity378/GenshinDraftPick/blob/main/Resources/Images/Generic_Icons/Empty.png?raw=true" class="mini-character"/>`;
          container.appendChild(slot);
        }
      }
    }


    // SCHIFO RISPOSTA SERVER
    socket.on("update-participants", (participants) => {
      /*
      participantsList.innerHTML = "";
      participants.forEach((user) => {
        const listItem = document.createElement("li");
        listItem.textContent = user.username;
        participantsList.appendChild(listItem);
      });
      */
    });

    socket.on("update-bans-teams-number", (_bansNumber, _teamsNumber, _blueUsername, _redUsername) => {
      bansNumber = _bansNumber;
      teamsNumber = _teamsNumber;
      blueUsernameText.innerText = _blueUsername;
      redUsernameText.innerHTML = _redUsername;
      createTeamSlots(blueSideBansContainer, bansNumber, "blue-ban-row");
      createTeamSlots(redSideBansContainer, bansNumber, "red-ban-row");
      createTeamSlots(blueSidePicksContainer, teamsNumber * 4, "blue-pick");
      createTeamSlots(redSidePicksContainer, teamsNumber * 4, "red-pick");
    });

    socket.on("user-disconnected", (username) => {
      console.log(username + " disconnected");
    });

    // ----------------------
    // GESTIONE PERSONAGGI DAL DB
    // ----------------------
    async function loadCharacters() {
      try {
        const res = await fetch("/characters");
        const characters = await res.json();

        const list = document.getElementById("characters-list");
        const searchBar = document.getElementById("search-bar");

        function renderList(filter = "") {
          list.innerHTML = "";
          characters
            .filter(c => c.Name.toLowerCase().includes(filter.toLowerCase()))
            .forEach((c) => {
              const img = document.createElement("img");
              img.src = c.ImageLink;
              img.id = c.Name;
              img.title = c.Name; // tooltip col nome
              if (allPicksAndBans.includes(c.Name)) {
                img.className = "disabled";
              } else
                img.className = `character star-${c.Stars}`;
              list.appendChild(img);
              img.addEventListener("click", () => {
                selectedCharacter = img.id;
                socket.emit("hovered-character", selectedCharacter, username, roomId);
                console.log(img.id);
              })

              savedCharacters.push({ name: c.Name, imageLink: c.ImageLink, stars: c.Stars })
            });
        }

        // Prima renderizzazione
        renderList();

        // Filtro mentre scrivo nella searchbar
        searchBar.addEventListener("input", (e) => {
          renderList(e.target.value);
        });

      } catch (err) {
        console.error("Error while loading character:", err);
      }
    }
    loadCharacters();

    function getImageLinkByName(name) {
      const character = savedCharacters.find(c => c.name === name);
      return character ? character.imageLink : null;
    }

    function getStarsByName(name) {
      const character = savedCharacters.find(c => c.name === name);
      return character ? character.stars : null;
    }

    function sumbitCharacter() {
      if (selectedCharacter == null) {
        alert("Devi prima selezionare un personaggio!");
        return;
      }
      socket.emit("selected-character", selectedCharacter, username, roomId);
    }
  </script>
</body>

</html>