<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Game Lobby</title>
  <link rel="stylesheet" href="/game_styles.css" />
</head>

<body>
  <div class="main-layout">
    <!-- Container chat -->
    <div id="chat-box-container">
      <div id="chat-box"></div>
      <input type="text" id="chat-input" placeholder="Send a message..." />
    </div>

    <!-- Container sinistro -->
    <div class="side-container left">
      <h2 id="blue-username" style="text-align: center">Blue</h2>
      <div id="blue-team-bans" class="blue-team-bans"></div>
      <div id="blue-team-picks" class="blue-team-picks"></div>
    </div>

    <!-- Container principale -->
    <div class="container">
      <h2 style="text-align: center">Characters</h2>
      <input type="text" id="search-bar" placeholder="Search for a character..." />
      <div id="characters-box">
        <div id="characters-list"></div>
      </div>
      <button id="submit-btn" class="submit-btn" onclick="sumbitCharacter()">Seleziona</button>
      <div id="current-phase" class="current-phase"></div>
    </div>

    <!-- Container destro -->
    <div class="side-container right">
      <h2 id="red-username" style="text-align: center">Red</h2>
      <div id="red-team-bans" class="red-team-bans"></div>
      <div id="red-team-picks" class="red-team-picks"></div>
      <!-- Contenuto opzionale -->
      <!-- <div class="bansNumber" id="bansNumber"></div> -->
      <!-- <div class="teamsNumber" id="teamsNumber"></div> -->
      <!-- <ul id="participants"></ul> -->
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const roomId = window.location.pathname.split("/")[2];
    const username = new URLSearchParams(window.location.search).get("username");
    const chatContainer = document.getElementById("chat-box-container");
    const chatBox = document.getElementById("chat-box");
    const chatInput = document.getElementById("chat-input");
    const sendBtn = document.getElementById("send-btn");
    const participantsList = document.getElementById("participants");
    const bansNumberText = document.getElementById("bansNumber");
    const teamsNumberText = document.getElementById("teamsNumber");
    const blueSideBansContainer = document.getElementById("blue-team-bans");
    const redSideBansContainer = document.getElementById("red-team-bans");
    const blueSidePicksContainer = document.getElementById("blue-team-picks");
    const redSidePicksContainer = document.getElementById("red-team-picks");
    const currentPhaseText = document.getElementById("current-phase");
    const redUsernameText = document.getElementById("red-username");
    const blueUsernameText = document.getElementById("blue-username");

    var msgSent = false;
    var selectedCharacter = null;
    var bansNumber = null;
    var teamsNumber = null;
    var savedCharacters = [];

    // ----------------------
    // GESTIONE GAME
    // ----------------------

    // Viene startato il game
    socket.emit("join-game", roomId, username);

    // Ricevuto un messaggio della chat
    socket.on("chat-message", (message) => {
      const messageElement = document.createElement("div");
      messageElement.textContent = message;
      chatBox.appendChild(messageElement);

      if (!chatContainer.classList.contains("active") || msgSent == true) {
        chatBox.scrollBy(0, chatBox.scrollHeight);
        msgSent = false;
      }
    });

    socket.on("update-game-state", (blueSideBans, redSideBans, blueSidePicks, redSidePicks, currentPhase) => {
      if (Array.isArray(blueSideBans)) {
        blueSideBans.forEach((char, i) => {
          const slot = document.getElementById(`blue-ban-slot-${i}`);
          slot.className = "blue-ban-slot";
          slot.innerHTML = char ? `<img src="${getImageLinkByName(char)}" title="${char}" class="mini-character star-${getStarsByName(char)}"/>` : "";
        });
      }
      if (Array.isArray(redSideBans)) {
        redSideBans.forEach((char, i) => {
          const slot = document.getElementById(`red-ban-slot-${i}`);
          slot.className = "red-ban-slot";
          slot.innerHTML = char ? `<img src="${getImageLinkByName(char)}" title="${char}" class="mini-character star-${getStarsByName(char)}"/>` : "";
        });
      }
      if (Array.isArray(blueSidePicks)) {
        blueSidePicks.forEach((char, i) => {
          const slot = document.getElementById(`blue-pick-slot-${i}`);
          slot.className = "blue-pick-slot";
          slot.innerHTML = char ? `<img src="${getImageLinkByName(char)}" title="${char}" class="mini-character star-${getStarsByName(char)}"/>` : "";
        });
      }
      if (Array.isArray(redSidePicks)) {
        redSidePicks.forEach((char, i) => {
          const slot = document.getElementById(`red-pick-slot-${i}`);
          slot.className = "red-pick-slot";
          slot.innerHTML = char ? `<img src="${getImageLinkByName(char)}" title="${char}" class="mini-character star-${getStarsByName(char)}"/>` : "";
        });
      }
      currentPhaseText.innerHTML = currentPhase;
    });

    // Espandi la chat e abilitala quando ci si clicca sopra
    chatContainer.addEventListener("click", (e) => {
      chatContainer.classList.add("active"); // espandi la chat

      if (e.target === chatInput) {
        // Se clicco sull'input: focus normale
        chatInput.focus();
      } else {
        // Se clicco altrove nel container: non focusare l'input
        chatInput.blur();
      }
    });

    // Risuci la chat se si clicca da qualche altra parte
    document.addEventListener("click", (e) => {
      if (!chatContainer.contains(e.target)) {
        chatContainer.classList.remove("active"); // riduci la chat
        chatInput.blur();
        chatBox.scrollBy(0, chatBox.scrollHeight);
      }
    });

    // Invio del messaggio nella chat
    chatInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        const message = chatInput.value.trim();
        if (message) {
          socket.emit("send-chat-message", roomId, message);
          chatInput.value = "";
        }
        e.preventDefault(); // previene invio del form se c'Ã¨
        msgSent = true;
      }
    });

    function createTeamSlots(container, slotsCount, type) {
      container.innerHTML = "";
      for (let i = 0; i < slotsCount; i++) {
        const slot = document.createElement("div");
        slot.className = `${type}-slot slot-empty`;
        slot.id = `${type}-slot-${i}`;
        container.appendChild(slot);
      }
    }


    // SCHIFO RISPOSTA SERVER
    socket.on("update-participants", (participants) => {
      /*
      participantsList.innerHTML = "";
      participants.forEach((user) => {
        const listItem = document.createElement("li");
        listItem.textContent = user.username;
        participantsList.appendChild(listItem);
      });
      */
    });

    socket.on("update-bans-teams-number", (_bansNumber, _teamsNumber, _blueUsername, _redUsername) => {
      bansNumber = _bansNumber;
      teamsNumber = _teamsNumber;
      blueUsernameText.innerText = _blueUsername;
      redUsernameText.innerHTML = _redUsername;
      createTeamSlots(blueSideBansContainer, bansNumber, "blue-ban");
      createTeamSlots(redSideBansContainer, bansNumber, "red-ban");
      createTeamSlots(blueSidePicksContainer, teamsNumber * 4, "blue-pick");
      createTeamSlots(redSidePicksContainer, teamsNumber * 4, "red-pick");
    });

    socket.on("user-disconnected", (username) => {
      console.log(username + " disconnected");
    });

    // ----------------------
    // GESTIONE PERSONAGGI DAL DB
    // ----------------------
    async function loadCharacters() {
      try {
        const res = await fetch("/characters");
        const characters = await res.json();

        const list = document.getElementById("characters-list");
        const searchBar = document.getElementById("search-bar");

        function renderList(filter = "") {
          list.innerHTML = "";
          characters
            .filter(c => c.Name.toLowerCase().includes(filter.toLowerCase()))
            .forEach((c) => {
              const img = document.createElement("img");
              img.src = c.ImageLink;
              img.id = c.Name;
              img.title = c.Name; // tooltip col nome
              img.className = `character star-${c.Stars}`;
              list.appendChild(img);
              img.addEventListener("click", () => {
                selectedCharacter = img.id;
                console.log(img.id);
              })

              savedCharacters.push({ name: c.Name, imageLink: c.ImageLink, stars: c.Stars })
            });
        }

        // Prima renderizzazione
        renderList();

        // Filtro mentre scrivo nella searchbar
        searchBar.addEventListener("input", (e) => {
          renderList(e.target.value);
        });
      } catch (err) {
        console.error("Error while loading character:", err);
      }
    }
    loadCharacters();

    function getImageLinkByName(name) {
      const character = savedCharacters.find(c => c.name === name);
      return character ? character.imageLink : null;
    }

    function getStarsByName(name) {
      const character = savedCharacters.find(c => c.name === name);
      return character ? character.stars : null;
    }

    function sumbitCharacter() {
      if (selectedCharacter == null) {
        alert("Devi prima selezionare un personaggio!");
        return;
      }
      socket.emit("selected-character", selectedCharacter, username, roomId);
    }
  </script>
</body>

</html>